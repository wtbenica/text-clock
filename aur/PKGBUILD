# Maintainer: Wesley Benica <wesley at benica dot dev>

pkgname=gnome-shell-extension-text-clock
pkgver=1.1.0
pkgrel=1
pkgdesc="A simple text clock for the GNOME Shell top panel"
arch=('any')
url="https://github.com/wtbenica/text-clock"
license=('GPL-3.0-or-later')
install="${pkgname}.install"
depends=('gnome-shell>=45')
makedepends=('unzip' 'curl')
# If you upload a detached signature for the release asset (e.g. text-clock@benica.dev.zip.sig)
# set your key ID below so `makepkg` can verify the download. Keep empty to skip verification.
validpgpkeys=('50483D39B066B9CAC0B0189A433660C4BA3A31AC')

source=(
    # Download the user-friendly unversioned release asset and signature
    "text-clock@benica.dev.zip::https://github.com/wtbenica/text-clock/releases/download/v${pkgver}/text-clock@benica.dev.zip"
    "text-clock@benica.dev.zip.sig::https://github.com/wtbenica/text-clock/releases/download/v${pkgver}/text-clock@benica.dev.zip.sig"
    # Public key for signature verification
    "${pkgname}-${pkgver}.key::https://raw.githubusercontent.com/wtbenica/text-clock/colorful/ci-pub.asc"
)
sha256sums=(
    'a4fc9a1f6597f2c7948c86c385ce117ca8f1eb2ce60c4dea2d4eddb6b2d0bc1c'
    'SKIP'
    'b7f0e54f80361ab240d6c6073c50d84872d7d8af39fa8485c43476656e03d835'
)
noextract=("text-clock@benica.dev.zip")

prepare() {
    # Import the public key into the build keyring for signature verification
    gpg --import "${srcdir}/${pkgname}-${pkgver}.key"

    # Rename downloaded unversioned asset to include version so AUR helpers keep distinct files
    if [ -f "${srcdir}/text-clock@benica.dev.zip" ]; then
        mv "${srcdir}/text-clock@benica.dev.zip" "${srcdir}/${pkgname}-${pkgver}.zip"
    else
        # fallback: download directly and name with version
        curl -L -o "${srcdir}/${pkgname}-${pkgver}.zip" \
            "https://github.com/wtbenica/text-clock/releases/download/v${pkgver}/text-clock@benica.dev.zip"
    fi

    if [ -f "${srcdir}/text-clock@benica.dev.zip.sig" ]; then
        mv "${srcdir}/text-clock@benica.dev.zip.sig" "${srcdir}/${pkgname}-${pkgver}.zip.sig"
    else
        curl -L -o "${srcdir}/${pkgname}-${pkgver}.zip.sig" \
            "https://github.com/wtbenica/text-clock/releases/download/v${pkgver}/text-clock@benica.dev.zip.sig" || {
            echo "Failed to download signature file."
            exit 1
        }
    fi
}

package() {
    local uuid="text-clock@benica.dev"
    local destdir="${pkgdir}/usr/share/gnome-shell/extensions/${uuid}"
    
    # Create the extension directory
    install -d "${destdir}"
    
    # Extract the extension ZIP file to the destination
    unzip -q "${srcdir}/${pkgname}-${pkgver}.zip" -d "${destdir}"
    
    # Set correct permissions: 644 for files, 755 for directories
    find "${destdir}" -type f -exec chmod 644 {} \;
    find "${destdir}" -type d -exec chmod 755 {} \;

    # Install GSettings schema to system location
    install -Dm644 "${destdir}/schemas/org.gnome.shell.extensions.text-clock.gschema.xml" \
        "${pkgdir}/usr/share/glib-2.0/schemas/org.gnome.shell.extensions.text-clock.gschema.xml"
}